class文件是一种与语言平台均无关的字节码文件，可以由不同的语言经过各自的编译器编译而来，均在JVM上运行

## 基本概念：

- 无符号数

  > 基本数据类型，以u1、u2... 表示一个字节、两个字节...

## class文件结构

| 类型           | 名称                            | 数量                  |
| -------------- | ------------------------------- | --------------------- |
| u4             | 魔数                            | 1                     |
| u2             | 次版本                          | 1                     |
| u2             | 主版本                          | 1                     |
| u2             | 常量池数量(constant-pool-count) | 1                     |
| cp_info        | 常量池                          | constant-pool-count-1 |
| u2             | 访问标记                        | 1                     |
| u2             | 当前类引用(this_class)          | 1                     |
| u2             | 父类引用(super_class)           | 1                     |
| u2             | 接口数量(interfaces_count)      | 1                     |
| u2             | 接口详情(interfaces)            | interfaces_count -1   |
| u2             | 变量数(field_count)             | 1                     |
| field_info     | 变量                            | field_count           |
| u2             | 方法数(method_count)            | 1                     |
| method_info    | 方法                            | method_count          |
| u2             | 属性数(attributes_count)        | 1                     |
| attribute_info | 属性                            | attributes_count      |

## class内容详解

### 魔数

> 通过一个四字节标识符来表示此文件的类型

### 次版本号 主版本号

> 版本号的意义是告诉虚拟机文件版本，低版本虚拟机执行超过其版本的`class`文件

### 常量池数量 常量池

#### 要点

- 常量池从1开始计数，0有其他作用

#### 存放内容

##### 字面量（常量）

- 文件字符串
- `final`常量

##### 符号引用

- 被模块导出或者开放的包
- 类和接口的全限定名
- 字段名称和描述符
- 方法签名和描述符
- 方法句柄和方法类型
- 动态调用点和动态常量

> 常量池存放内容结构均定义在常量表中，常量表中17中不同常量（截止到`JDK13`），例如：
>
> `UTF-8编码字符串`、`整型`...等常量类型
>
> 常量表中每种数据结构都有自己结构类型

可以使用`javap -verbose `分析`class`文件当前目录下[HelloCompiled.txt](./HelloCompiled.txt)是[Hello.class](./Hello.class)的编译结果。

### 访问标识

截止到`JDK13`，只定义了9种标识为，用以描述当前`class`的访问标识，如

- 类与接口标识
- `final`标识
- 抽象类标识
- ...

9种标识中符和当前类的标识进行 `|`操作，得到的结果记录在class文件访问标识所在位置

### 类索引、父类索引、接口索引集合

> 这三项属性确定类的继承关系 
>
> 类索引、父类索引都是通过指向一个CONSTANT_Class_info的类描述常量中的索引值找到对应的类型

#### 类索引

> 用来确定类的全限定名

#### 父类索引

> 用来确定父类的全限定名

#### 接口索引

> 接口索引第一项为接口数量。如果为零，接口索引就不再占据位置
>
> 接口索引按照关键字`implements`或者`extends`后内容顺序排列到索引集合中

### 变量数 变量

变量部分入口是变量的数量；

然后是变量内容，同样的需要存在一个结构记录变量的各种信息，叫做变量表，如下：

| 类型           | 名称                       | 数量             |
| -------------- | -------------------------- | ---------------- |
| u2             | 访问标识                   | 1                |
| u2             | 名称索引                   | 1                |
| u2             | 描述符                     | 1                |
| u2             | 属性数量(attributes_count) | 1                |
| attribute_info | 属性信息                   | attributes_count |

- 访问标识与类访问标识定义方法相同

- 名称索引，变量的名称在常量池中的地址
- 描述符介绍了变量的数据类型

> 补充信息：
>
> 全限定名是包名+类名
>
> 简单名称是类名、方法名、变量名
>
> 描述符是描述字段的数据类型，方法的参数列表和返回值等，同样有一个数据结构表记录数据结构与描述符映射关系的表，叫做描述符标识字符含义表

### 方法数 方法

方法部分入口是方法的数量；

然后是方法内容，同样的需要存在一个结构记录方法的各种信息，叫做方法表，如下

| 类型           | 名称                       | 数量             |
| -------------- | -------------------------- | ---------------- |
| u2             | 访问标识                   | 1                |
| u2             | 名称索引                   | 1                |
| u2             | 描述符                     | 1                |
| u2             | 属性数量(attributes_count) | 1                |
| attribute_info | 属性信息                   | attributes_count |

基本与变量定义方式相同

> 补充，在`javac`编译的过程中，会添加一些必须的方法，例如构造函数等
>
> 方法的重载是判断两个方法是否存在相同的特征签名
>
> 特征签名：
>
> - 方法名称
> - 参数数量
> - 参数顺序
> - 参数类型

### 属性数 属性

截止到`JDK13`属性表内已经有29种预定义属性，我们只分析一些比较重要和常见的属性

#### `code`属性

> 一个方法如果存在方法体，那么就需要在他的方法表的属性部分加上code属性

| 类型           | 名称                               | 数量                   |
| -------------- | ---------------------------------- | ---------------------- |
| u2             | 属性名称                           | 1                      |
| u4             | 属性长度                           | 1                      |
| u2             | 最大操作数栈深度                   | 1                      |
| u2             | 局部变量所需存储空间               | 1                      |
| u4             | 字节码长度(code_length)            | 1                      |
| u1             | 字节码                             | code_length            |
| u2             | 异常表长度(exception_table_length) | 1                      |
| exception_info | 异常表                             | exception_table_length |
| u2             | 属性数(attributes_count)           | 1                      |
| attribute_info | attributes                         | attribute_count        |

- 属性名称:固定值，标识当前属性名称
- 属性长度，标识当前属性长度
- 最大操作数栈深度：虚拟机会根据这个值分配栈帧中操作栈深度
- 局部变量所需存储空间：单位是(Slot)，这里使用的`slot`会在某一变量作用于执行完成后进行复用
- 