# 日志记录规范

## 日志目的

- **「问题追踪」**：辅助排查和定位线上问题，优化程序运行性能。
- **「状态监控」**：通过日志分析，可以监控系统的运行状态。
- **「安全审计」**：审计主要体现在安全上，可以发现非授权的操作。

## 日志的记录时机

- **「编程语言提示异常」**：如今各类主流的编程语言都包括异常机制，业务相关的流行框架有完整的异常模块。这类捕获的异常是系统告知开发人员需要加以关注的，是质量非常高的报错。应当适当记录日志，根据实际结合业务的情况使用warn或者error级别。
- **「业务流程预期不符」**：除开平台以及编程语言异常之外，项目代码中结果与期望不符时也是日志场景之一，简单来说所有流程分支都可以加入考虑。取决于开发人员判断能否容忍情形发生。常见的合适场景包括外部参数不正确，数据处理问题导致返回码不在合理范围内等等。
- **「系统核心角色，组件关键动作」**：系统中核心角色触发的业务动作是需要多加关注的，是衡量系统正常运行的重要指标，建议记录INFO级别日志，比如各服务节点交互；核心数据表增删改；核心组件运行等等，如果日志频度高或者打印量特别大，可以提炼关键点INFO记录，其余酌情考虑DEBUG级别。
- **「系统初始化」**：系统或者服务的启动参数。核心模块或者组件初始化过程中往往依赖一些关键配置，根据参数不同会提供不一样的服务。务必在这里记录INFO日志，打印出参数以及启动完成态服务表述。

## 日志的内容

- 日志时间
- 日志级别主要使用
- 调用链标识（可选）
- 线程名称
- 日志记录器名称
- 日志内容
  - 调用参数
  - 打印原因（什么情况下会输出此条日志）
- 异常堆栈（不一定有）

## 日志级别

- DEBUG：DEUBG 级别的主要输出调试性质的内容，该级别日志主要用于在开发、测试阶段输出。该级别的日志应尽可能地详尽，开发人员可以将各类详细信息记录到DEBUG里，起到调试的作用，包括参数信息，调试细节信息，返回值信息等等，便于在开发、测试阶段出现问题或者异常时，对其进行分析。
- INFO：INFO日志主要记录系统关键信息，旨在保留系统正常工作期间关键运行指标，开发人员可以将初始化系统配置、业务状态变化信息，或者用户业务流程中的核心处理记录到INFO日志中，方便日常运维工作以及错误回溯时上下文场景复现。建议在项目完成后，在测试环境将日志级别调成 INFO，然后通过 INFO 级别的信息看看是否能了解这个应用的运用情况，如果出现问题后是否这些日志能否提供有用的排查问题的信息。
- WARN：WARN 级别的主要输出警告性质的内容，这些内容是可以预知且是有规划的，比如，某个方法入参为空或者该参数的值不满足运行该方法的条件时。在 WARN 级别的时应输出较为详尽的信息，以便于事后对日志进行分析
- ERROR：ERROR 级别主要针对于一些不可预知的信息，诸如：错误、异常等，比如，在 catch 块中抓获的网络通信、数据库连接等异常，若异常对系统的整个流程影响不大，可以使用 WARN 级别日志输出。在输出 ERROR 级别的日志时，尽量多地输出方法入参数、方法执行过程中产生的对象等数据，在带有错误、异常对象的数据时，需要将该对象一并输出

## 日志级别的选择

### **DEBUG**

**「debug」**级别日志是调试阶段主要监控手段，会记录大量的过程信息，甚至变量信息，并且很多框架自身也有很多`debug`级别日志信息，所以只能开发阶段使用，生产阶段需要关注的信息不可使用此级别

### **INFO**

**「info」**级别日志是项目阶段主要监控手段，会记录大量的请求信息和运行信息，但是，如果这一级别中的某些日志在查错，监控阶段都不会对运维产生帮助，就应该下调至`debug`级别，每个`info`日志都需要在以下角度思考是否合适

- 是否对错误排查或者系统必要统计有帮助
- 日志描述是否可以清楚的描述问题或此时系统状态

### **WARN**

**「warn」**级别日志是对项目中可能存在的问题的预警，但是不会影响系统流程，不要使用此级别日志记录普通业务或系统信息，简单理解就是，此级别日志记录了项目的可优化项。

### **ERROR**

**「error」**级别日志是项目运行产生的重大异常记录，出现此日志的情况下，项目已经不能正常的提供服务，需要邮件甚至短信提醒，必须马上有人处理，所以普通警告之类日志绝对不能使用此异常，以免麻痹运维人员神经，导致忽略需要处理的异常，对于此异常，应有以下原则：

- 尽可能的增加逻辑来处理可能出现的异常，减少报警次数

- 异常记录完成后，已经邮件或者其他方式可以通知到维护人员，后续不要继续抛出异常，以免对下游服务产生影响

- 日志内容要清晰

  - 准备描述问题出现地点，定位到具体行号

  - 尽可能记录出现问题时的上下文信息，包括方法参数，调用返回值等

  - 尽可能描述发生了什么问题，会有哪些服务收到影响

  - 尽可能描述此问题可能的发生原因，以及各原因对应的解决方案或者可以解决问题的人员信息

    ```css
    log.error(“[接口名和方法名] [Some Error Msg] happens. [Probably Because]. [Probably need to do] [params] .”);
    log.error(“[接口名和方法名] [Some Error Msg] happens. [Probably Because]. [please contact xxx@xxx] [params] .”);
    ```

## 日志规范

- 不要随意输出日志

- 不要在生产环境使用**「DEBUG」**日志级别

- 不要使用错误的日志级别

- 不要在循环中打印日志

- 不要输出关键信息，密码，关键key等

- 如果可以判断日志级别后进行打印。当前日志级别是**「warn」**,第一种也会进行字符串拼接工作，但是却不会打印，白白浪费资源

  ```java
  //错误
  logger.debug("Processing trade with id: " + id + " symbol: " + symbol); 
  //正确
  if (logger.isDebugEnabled()) {
                logger.debug("Processing trade with id: " + id + " symbol: " + symbol);
  } 
  ```

- 不要在日志中执行调用操作

  ```java
  User user = getUser();
  try{
    // code here
  }catch(Exception ex){
    //错误
    log.error("has error,where user is {}",user.name);
    //正确
    log.error("has error,where user is {}",user);
  }
  ```

- 不要打印对调试或者错误排查没有帮助的日志

  ```java
  public User findUser(String name){
    	User user ;
  	try{
    	user = getUser()
  	}catch(Exception ex){
    //错误
    log.error("has error in find user");
    //正确
    log.error("has error while find user, param is {}",name);
  }
  }
  
  ```

- 打印堆栈信息，不要直接使用`ex`变量，这样不会输出堆栈

  ```java
  log.error( "Invoking com.service.UserService cause error, username: {}, e: {}" , username , e );
  ```

- 不要重复打印

  ```java
  //重复情况，相同内容多次记录
  log.error(e.getMessage(),e);
  //重复情况，日志记录完成都再次抛出
  log.error(e.getMessage());
  throw new RunTimeException();
  ```

- 记录日志时请思考：这些日志真的有人看吗？看到这条日志你能做什么？能不能给问题排查带来好处？

## 日志文件

日志文件放置于固定的目录中，按照一定的模板进行命名，推荐的日志文件名称：

```css
当前正在写入的日志文件名：<应用名>[-<功能名>].log
已经滚入历史的日志文件名：<应用名>[-<功能名>].log.<yyyy-MM-dd>
eg:appName_logType_logName.log
```

- 测试环境或者生产环境输出到文件中，每天产生一个文件，如果日志量庞大可以每个小时产生一个日志文件
- 生产环境中的文件输出，可以考虑使用异步文件输出，该种方式日志并不会马上刷新到文件中去，会产生日志延时，在停止应用时可能会导致一些还在内存中的日志未能及时刷新到文件中去而产生丢失，如果对于应用的要求并不是非常高的话，可暂不考虑异步日志

## 报警邮件

需要明确的是只有**「error」**级别的错误需要报警邮件，否则真正的错误会被太多的邮件覆盖，导致处理不及时，报警邮件只需要将**「error」**级别日志打印附在正文即可，并且可以有以下原则

- 无法修复并且无需关注项目的人员不订阅邮件
- 邮件需要打印完整日志信息

## 日志更新方案

- 更新代码，优化日志处理
- 利用`AOP`，增加关键方法增强处理，添加日志记录

